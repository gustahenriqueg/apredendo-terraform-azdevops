trigger:
  branches:
    include:
      - main

pool:
  vmImage: ubuntu-latest

variables:
  terraformVersion: '1.5.5'
  azureServiceConnection: 'wf-terraform'
  backendResourceGroup: 'rg-tfstate-dev-001'
  backendStorageAccount: 'sttfstatedev001gustavo'
  backendContainer: 'tfstate'
  backendKey: 'terraform.tfstate'
  # Definimos o nome do arquivo de plano como variável para facilitar
  planFileName: 'tfplan'

stages:
  # Stage 1: CI - Validate & Plan
  - stage: CI_Plan
    displayName: 'CI - Plan Infrastructure'
    jobs:
      - job: TerraformPlan
        displayName: 'Terraform Init, Validate & Plan'
        steps:
          - task: TerraformInstaller@0
            displayName: 'Install Terraform'
            inputs:
              terraformVersion: $(terraformVersion)

          - task: TerraformTaskV4@4
            displayName: 'Terraform Init'
            inputs:
              provider: 'azurerm'
              command: 'init'
              backendServiceArm: $(azureServiceConnection)
              backendAzureRmResourceGroupName: $(backendResourceGroup)
              backendAzureRmStorageAccountName: $(backendStorageAccount)
              backendAzureRmContainerName: $(backendContainer)
              backendAzureRmKey: $(backendKey)
              workingDirectory: 'terraform'

          - task: TerraformTaskV4@4
            displayName: 'Terraform Plan'
            inputs:
              provider: 'azurerm'
              command: 'plan'
              # Geramos o arquivo
              commandOptions: '-out=$(planFileName)'
              environmentServiceNameAzureRM: $(azureServiceConnection)
              workingDirectory: 'terraform'

          # CORREÇÃO AQUI: Copiamos o tfplan para um lugar limpo antes de publicar
          # Isso evita pegar a pasta .terraform "suja"
          - task: CopyFiles@2
            displayName: 'Stage Plan File'
            inputs:
              SourceFolder: 'terraform'
              Contents: '$(planFileName)' # Pega SÓ o arquivo do plano
              TargetFolder: '$(Build.ArtifactStagingDirectory)'

          - task: PublishPipelineArtifact@1
            displayName: 'Publish Plan Artifact'
            inputs:
              targetPath: '$(Build.ArtifactStagingDirectory)' # Publica o que copiamos acima
              artifactName: 'terraform-plan-artifact'

  # Stage 2: CD - Apply
  - stage: CD_Apply
    displayName: 'CD - Apply Infrastructure'
    dependsOn: CI_Plan
    condition: succeeded()
    jobs:
      - job: TerraformApply
        displayName: 'Terraform Apply'
        steps:
          # O Checkout acontece automaticamente, trazendo os .tf limpos
          
          # 1. Baixa o artefato (apenas o arquivo tfplan)
          - task: DownloadPipelineArtifact@2
            displayName: 'Download Plan Artifact'
            inputs:
              artifactName: 'terraform-plan-artifact'
              # Baixa para a pasta onde o código fonte já está (pelo checkout)
              downloadPath: '$(System.DefaultWorkingDirectory)/terraform' 

          - task: TerraformInstaller@0
            displayName: 'Install Terraform'
            inputs:
              terraformVersion: $(terraformVersion)

          # 2. Init vai baixar os providers com as permissões corretas, pois a pasta .terraform não existe aqui ainda
          - task: TerraformTaskV4@4
            displayName: 'Terraform Init'
            inputs:
              provider: 'azurerm'
              command: 'init'
              backendServiceArm: $(azureServiceConnection)
              backendAzureRmResourceGroupName: $(backendResourceGroup)
              backendAzureRmStorageAccountName: $(backendStorageAccount)
              backendAzureRmContainerName: $(backendContainer)
              backendAzureRmKey: $(backendKey)
              workingDirectory: 'terraform'

          # 3. Aplica usando o arquivo que veio do artefato
          - task: TerraformTaskV4@4
            displayName: 'Terraform Apply'
            inputs:
              provider: 'azurerm'
              command: 'apply'
              commandOptions: '$(planFileName)' 
              environmentServiceNameAzureRM: $(azureServiceConnection)
              workingDirectory: 'terraform'